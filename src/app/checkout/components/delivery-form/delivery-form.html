
<form [formGroup]="deliveryForm" (ngSubmit)="onSubmit()">
  
  <div class="bg-white rounded-lg shadow-lg p-6 space-y-6">
    
    <section>
      <h2 class="text-2xl font-bold text-primary mb-4">Datos de contacto</h2>
      
      <div class="mb-4">
        <label for="name" class="label">
          <span class="label-text font-semibold">Nombre completo *</span>
        </label>
        <input 
          id="name"
          type="text"
          formControlName="customerName"
          placeholder="Ej: Mar铆a Garc铆a"
          class="input input-bordered w-full"
          [class.input-error]="hasError('customerName')"
          aria-required="true"
        />
        @if (hasError('customerName')) {
          <p class="text-error text-sm mt-1">{{ getError('customerName') }}</p>
        }
      </div>

      <div class="mb-4">
        <label for="email" class="label">
          <span class="label-text font-semibold">Email *</span>
        </label>
        <input 
          id="email"
          type="email"
          formControlName="customerEmail"
          placeholder="tu@email.com"
          class="input input-bordered w-full"
          [class.input-error]="hasError('customerEmail')"
          aria-required="true"
        />
        @if (hasError('customerEmail')) {
          <p class="text-error text-sm mt-1">{{ getError('customerEmail') }}</p>
        }
      </div>

      <div class="mb-4">
        <label for="phone" class="label">
          <span class="label-text font-semibold">Tel茅fono *</span>
        </label>
        <input 
          id="phone"
          type="tel"
          formControlName="customerPhone"
          placeholder="Ej: 612345678"
          class="input input-bordered w-full"
          [class.input-error]="hasError('customerPhone')"
          aria-required="true"
        />
        @if (hasError('customerPhone')) {
          <p class="text-error text-sm mt-1">{{ getError('customerPhone') }}</p>
        }
      </div>
    </section>

    <div class="divider"></div>

    <section>
      <h2 class="text-2xl font-bold text-primary mb-4">Direcci贸n de entrega</h2>
      
      <div class="mb-4 relative">
        <label for="address" class="label">
          <span class="label-text font-semibold">Direcci贸n *</span>
        </label>
        <input 
            id="address"
            type="text"
            formControlName="deliveryAddress"
            (input)="onAddressInput($event)"
            (keydown)="onAddressKeydown($event)"
            placeholder="Escribe tu direcci贸n..."
            class="input input-bordered w-full"
            [class.input-error]="hasError('deliveryAddress')"
            aria-required="true"
            aria-autocomplete="list"
            [attr.aria-expanded]="addressSuggestions().length > 0"
            aria-controls="address-suggestions"
            autocomplete="off"
        />
        
        @if (addressSuggestions().length > 0) {
            <ul 
            id="address-suggestions"
            class="absolute z-10 w-full bg-white border border-border rounded-lg shadow-lg mt-1 max-h-60 overflow-auto"
            role="listbox"
            aria-label="Sugerencias de direcci贸n">
            @for (suggestion of addressSuggestions(); track suggestion.id; let i = $index) {
                <li 
                (click)="selectAddress(suggestion)"
                (mouseenter)="selectedSuggestionIndex.set(i)"
                [class.bg-primary]="selectedSuggestionIndex() === i"
                [class.text-white]="selectedSuggestionIndex() === i"
                [class.hover:bg-secondary]="selectedSuggestionIndex() !== i"
                class="px-4 py-2 cursor-pointer transition-colors"
                role="option"
                [attr.aria-selected]="selectedSuggestionIndex() === i">
                {{ suggestion.place_name }}
                </li>
            }
            </ul>
        }
        
        @if (hasError('deliveryAddress')) {
          <p class="text-error text-sm mt-1">{{ getError('deliveryAddress') }}</p>
        }
      </div>

      <div class="mb-4">
        <label for="details" class="label">
          <span class="label-text font-semibold">Detalles adicionales (opcional)</span>
        </label>
        <input 
          id="details"
          type="text"
          formControlName="deliveryDetails"
          placeholder="Piso, puerta, timbre..."
          class="input input-bordered w-full"
        />
      </div>
    </section>

    <div class="mb-4">
  <div class="form-control">
    <label class="label cursor-pointer justify-start gap-3">
      <input 
        type="checkbox"
        formControlName="sameAsBilling"
        class="checkbox checkbox-primary"
      />
      <span class="label-text">
        La direcci贸n de facturaci贸n es la misma que la de entrega.
      </span>
    </label>
  </div>

    @if (!deliveryForm.get('sameAsBilling')?.value) {
    <div class="alert alert-info bg-background mt-2">
        <span aria-hidden="true">癸</span>
        <p class="text-sm text-text">
        Si necesitas una direcci贸n de facturaci贸n diferente, ind铆cala en las 
        <strong>notas especiales</strong> al final del formulario.
        </p>
    </div>
    }
    </div>
    <div class="divider"></div>

    <section>
      <h2 class="text-2xl font-bold text-primary mb-4">Fecha y hora de entrega</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div>
          <label for="date" class="label">
            <span class="label-text font-semibold">Fecha *</span>
          </label>
          <input 
            id="date"
            type="date"
            formControlName="deliveryDate"
            [min]="minDate"
            class="input input-bordered w-full"
            [class.input-error]="hasError('deliveryDate')"
            aria-required="true"
          />
          @if (hasError('deliveryDate')) {
            <p class="text-error text-sm mt-1">{{ getError('deliveryDate') }}</p>
          }
        </div>

        <div>
          <label for="time" class="label">
            <span class="label-text font-semibold">Franja horaria *</span>
          </label>
          <select 
            id="time"
            formControlName="deliveryTime"
            class="select select-bordered w-full"
            [class.select-error]="hasError('deliveryTime')"
            aria-required="true">
            <option value="" disabled>Selecciona una franja</option>
            @for (slot of timeSlots; track slot.value) {
              <option [value]="slot.value">{{ slot.label }}</option>
            }
          </select>
          @if (hasError('deliveryTime')) {
            <p class="text-error text-sm mt-1">{{ getError('deliveryTime') }}</p>
          }
        </div>
      </div>
    </section>

    <div class="divider"></div>

    <section>
      <h2 class="text-2xl font-bold text-primary mb-4">Notas especiales (opcional)</h2>
      
      <textarea 
        formControlName="notes"
        rows="3"
        placeholder="Dedicatoria, instrucciones especiales..."
        class="textarea textarea-bordered w-full"
      ></textarea>
      <p class="text-sm text-text/60 mt-1">
         Puedes a帽adir una dedicatoria o instrucciones especiales
      </p>
    </section>

    <button 
      type="submit"
    [disabled]="deliveryForm.invalid"
      class="btn btn-primary btn-lg w-full"
      aria-label="Confirmar pedido">
       Proceder al pago
    </button>

  </div>
</form>